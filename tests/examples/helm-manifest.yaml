apiVersion: unfurl/v1alpha1
kind: Manifest
spec:
  tosca:
    # unfurl.relationships.InstalledBy used for implementation if no implementation is specified
    node_types:
      unfurl.nodes.HelmRelease:
        derived_from: unfurl.nodes.Installation
        requirements:
        - host:
            node: unfurl.nodes.K8sNamespace
            relationship: tosca.relationships.HostedOn
        - install:
            node: unfurl.nodes.Installer
            relationship: unfurl.relationships.InstalledBy
        properties:
          chart:
            type: string
          release_name:
            type: string
        interfaces:
          Install:
            type: unfurl.interfaces.install.Helm
            inputs:
              chart: {get_property: ['SELF', 'chart']}
              release_name: {get_property: ['SELF', 'release_name']}

    interface_types:
      unfurl.interfaces.install.Helm:
        derived_from: unfurl.interfaces.Install
        inputs:
          chart:
            type: string
          release-name:
            type: string
          flags:
            type: list
            required: false

    topology_template:
      node_templates:
        helm-installer:
          type: unfurl.nodes.Installer
          properties:
            implements:
              - unfurl.interfaces.install.Helm
            operations:
              shared:
                implementation:
                  primary: DummyShellConfigurator
                  timeout: 9999
                  operation_host: ORCHESTRATOR # SELF or HOST or resource name
                  environment:
                    isolate: true
                    addinputs: true
                    passvars:
                      - ANSIBLE_VERBOSITY
                      - UNFURL_LOGGING
                      - ANDROID_*
                    vars:
                      FOO: "{{}}"
              default:
                implementation: HelmConfigurator
              instantiate:
                inputs:
                  helmcmd: install
                  command:
                    eval:
                      template: |
                        helm {{inputs.helmcmd}} {{inputs.release_name}} {{inputs.chart}}
                          # XXX namespace= .::namespace,
                          # {%if .kubecontext, --kubecontext}} {%if .kubeconfig
                          {%if task.dryrun%}--dry-run{%endif%}
                          --values {{ valuesfile }}
                          {%if task.verbose%}--debug{%endif%}
                          {%if task.timeout%}--timeout {{task.timeout}}{%endif%}
                          {%if inputs.flags%}
                          {%for flag, value in inputs.flags.items() %}
                            --{{flag}} "{{value}}"
                          {%endfor%}
                          {%endif%}
                      vars:
                        valuesfile:
                          eval:
                            tempfile: $inputs::values
              update:
                  helm upgrade [RELEASE] [CHART] [flags]
              delete:
                inputs:
                  command: helm uninstall RELEASE_NAME
              discover:
                inputs:
                  command: helm get manifest RELEASE_NAME
                  resultTemplate: >
                    {%for doc in output | yaml %}
                      {%if doc.kind|defined %}
                      name: doc.spec.name
                      parent: .self
                      nodeType: unfurl.nodes.K8sResource # or secret if doc[kind] is
                    secret
                      attributes:
                        apiResource:
                          doc
                      # status: if doc[status][...]
                      {%endif%}
                    {% endfor %}

        gitlab-release:
          type: unfurl.nodes.HelmRelease
          requirements:
            - host:    defaultNamespace
            - install: helm-installer
          properties:
            chart: gitlab/gitlab
            release-name: foo
          interfaces:
            Install:
              inputs:
                flags:
                  - repo: https://charts.gitlab.io/
                values:
                  certmanager-issuer.email: admin@onecommons.org
                  global:
                    hosts:
                      domain:
                        eval: ::homedomain

        stagingCluster:
          type: unfurl.nodes.K8sCluster
          properties:
            connection:
              context: docker-for-desktop

        defaultNamespace:
          type: unfurl.nodes.K8sNamespace
          requirements:
          - host: stagingCluster
          properties:
            name: default
